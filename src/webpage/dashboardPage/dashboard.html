<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heart Track - Dashboard</title>
    <link rel="stylesheet" type="text/css" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="sidebar">
        <button id="toggleSidebar">></button>
        <ul>
            <li><button id="addDeviceButton">Add/Remove Device</button></li>
            <li><button id="changePasswordButton">Change Password</button></li>
            <li><button id="logoutButton">Logout</button></li>
        </ul>
    </div>

    <div id="container">
        <section id="greeting">
            <h1 id="usernameGreeting">Welcome</h1>
        </section>
        
        <section id="weeklySummary">
            <h2>Weekly Summary</h2>
            <p>Average Heart Rate: <span id="avgHeartRate">[Value]</span></p>
            <p>Minimum Heart Rate: <span id="minHeartRate">[Value]</span></p>
            <p>Maximum Heart Rate: <span id="maxHeartRate">[Value]</span></p>
            <p>Average Blood Oxygen Level: <span id="avgBloodOxygen">[Value]</span></p>
            <p>Minimum Blood Oxygen Level: <span id="minBloodOxygen">[Value]</span></p>
            <p>Maximum Blood Oxygen Level: <span id="maxBloodOxygen">[Value]</span></p>
        </section>

        <section id="measurementSettings">
            <h2>Measurement Settings</h2>
            <form id="settingsForm">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime">
                <label for="frequency">Frequency:</label>
                <input type="number" id="frequency" placeholder="Minutes">
                <button type="submit">Save Settings</button>
            </form>
        </section>

        <section id="dailyView">
            <h2>Detailed Daily View</h2>
            <canvas id="heartRateChart"></canvas>
            <canvas id="bloodOxygenChart"></canvas>
        </section>
    </div>

    <script>
        let heartRateChart;
        let bloodOxygenChart;
        let allReadings = [];

        document.getElementById('toggleSidebar').addEventListener('click', function() {
            // document.body.classList.toggle('sidebar-expanded');
            const sidebarExpanded = document.body.classList.toggle('sidebar-expanded');
            this.textContent = sidebarExpanded ? '<' : '>';
        });

        document.getElementById('addDeviceButton').addEventListener('click', function() {
            window.location.href = "../registerPage/device.html";
        });

        document.getElementById('changePasswordButton').addEventListener('click', function() {
            window.location.href = "../registerPage/password.html";
        });

        window.addEventListener('DOMContentLoaded', async (event) => {
            console.log("Before username")
            const username = localStorage.getItem('username');
            console.log("username is :" + username)
            if (username) {
                document.getElementById('usernameGreeting').textContent = `Welcome, ${username}`;
                let apiPath = `http://3.12.231.73/:3000/api/getDeviceData/${username}`

                console.log("about to fetch at: " + apiPath)
                
                try {
                    // Using template literals for dynamic URL
                    const response = await fetch(`http://3.12.231.73:3000/api/getDeviceData/${username}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(data);

                    updateCharts(data.readings);
                    allReadings = data.readings; // Store fetched readings
                    updateCharts(allReadings); // Initial chart update
                } catch (error) {
                    console.error('Error fetching device data:', error);
                }
            }
        });

        document.getElementById('settingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            filterAndUpdateCharts();
        });

        function filterAndUpdateCharts() {
            if (heartRateChart) heartRateChart.destroy();
            if (bloodOxygenChart) bloodOxygenChart.destroy();
            const startTimeInput = document.getElementById('startTime').value;
            const endTimeInput = document.getElementById('endTime').value;
            const frequency = parseInt(document.getElementById('frequency').value) || 1;

            let filteredReadings = allReadings.filter(reading => {
                const readingDate = new Date(reading.timestamp);
                const readingHour = readingDate.getHours();
                const readingMinutes = readingDate.getMinutes();

                const [startHour, startMinutes] = startTimeInput ? startTimeInput.split(':').map(Number) : [0, 0];
                const [endHour, endMinutes] = endTimeInput ? endTimeInput.split(':').map(Number) : [23, 59];

                return (readingHour > startHour || (readingHour === startHour && readingMinutes >= startMinutes)) &&
                    (readingHour < endHour || (readingHour === endHour && readingMinutes <= endMinutes));
            });

            filteredReadings = filteredReadings.filter((_, index) => index % frequency === 0);

            updateCharts(filteredReadings);
        }

        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '../index.html';
        });

        function calculateAverage(data) {
            if (data.length === 0) return 0;
            const sum = data.reduce((a, b) => a + b, 0);
            return sum / data.length;
        }

        function updateCharts(readings) {
            const labels = readings.map(reading => reading.timestamp);
            const heartRateData = readings.map(reading => reading.heartRate);
            const bloodOxygenData = readings.map(reading => reading.bloodOxygen);

            const avgHeartRate = calculateAverage(heartRateData);
            const minHeartRate = Math.min(...heartRateData);
            const maxHeartRate = Math.max(...heartRateData);

            const avgBloodOxygen = calculateAverage(bloodOxygenData);
            const minBloodOxygen = Math.min(...bloodOxygenData);
            const maxBloodOxygen = Math.max(...bloodOxygenData);

            document.getElementById('avgHeartRate').textContent = avgHeartRate.toFixed(2);
            document.getElementById('minHeartRate').textContent = minHeartRate;
            document.getElementById('maxHeartRate').textContent = maxHeartRate;

            document.getElementById('avgBloodOxygen').textContent = avgBloodOxygen.toFixed(2);
            document.getElementById('minBloodOxygen').textContent = minBloodOxygen;
            document.getElementById('maxBloodOxygen').textContent = maxBloodOxygen;

            const ctx1 = document.getElementById('heartRateChart').getContext('2d');
            heartRateChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Heart Rate',
                        data: heartRateData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                }
            });

            const ctx2 = document.getElementById('bloodOxygenChart').getContext('2d');
            bloodOxygenChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Blood Oxygen Level',
                        data: bloodOxygenData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                }
            });
        }        
    </script>
</body>
</html>
