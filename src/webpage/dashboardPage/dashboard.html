<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heart Track - Dashboard</title>
    <link rel="stylesheet" type="text/css" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="container">
        
        <!-- User Greeting -->
        <section id="greeting">
            <h1 id="usernameGreeting">Welcome</h1>
        </section>
        
        <!-- Weekly Summary -->
        <section id="weeklySummary">
            <h2>Weekly Summary</h2>
            <p>Average Heart Rate: [Value]</p>
            <p>Minimum Heart Rate: [Value]</p>
            <p>Maximum Heart Rate: [Value]</p>
            <p>Average Blood Oxygen Level: [Value]</p>
            <p>Minimum Blood Oxygen Level: [Value]</p>
            <p>Maximum Blood Oxygen Level: [Value]</p>
        </section>

        <section id="measurementSettings">
            <h2>Measurement Settings</h2>
            <form id="settingsForm">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime">
                <label for="frequency">Frequency:</label>
                <input type="number" id="frequency" placeholder="Minutes">
                <button type="submit">Save Settings</button>
            </form>
        </section>

        <!-- Detailed Daily View -->
        <section id="dailyView">
            <h2>Detailed Daily View</h2>
            <canvas id="heartRateChart"></canvas>
            <canvas id="bloodOxygenChart"></canvas>
        </section>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', async (event) => {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('usernameGreeting').textContent = `Welcome, ${username}`;

                try {
                    const response = await fetch('http://localhost:3000/api/getDeviceData', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userName: username })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Assuming 'data' contains an array of readings
                    updateCharts(data.readings);
                } catch (error) {
                    console.error('Error fetching device data:', error);
                }
            }
        });

        function updateCharts(readings) {
            const labels = readings.map(reading => reading.timestamp);
            const heartRateData = readings.map(reading => reading.heartRate);
            const bloodOxygenData = readings.map(reading => reading.bloodOxygen);

            // Update Heart Rate Chart
            const ctx1 = document.getElementById('heartRateChart').getContext('2d');
            const heartRateChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Heart Rate',
                        data: heartRateData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                }
            });

            // Update Blood Oxygen Chart
            const ctx2 = document.getElementById('bloodOxygenChart').getContext('2d');
            const bloodOxygenChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Blood Oxygen Level',
                        data: bloodOxygenData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                }
            });
        }
    </script>
</body>
</html>
